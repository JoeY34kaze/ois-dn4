<!DOCTYPE html>
<html>
    <head>
        <script src ="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
        <style>
            path { 
                stroke: steelblue;
                stroke-width: 2;
                fill: none;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: grey;
                stroke-width: 1;
                shape-rendering: crispEdges;
            }
        </style>
    </head>
    <body onload="init()">
    bla
    <script>
    var baseUrl = 'https://rest.ehrscape.com/rest/v1';
    var queryUrl = baseUrl + '/query';
    var username = "ois.seminar";
    var password = "ois4fri";
    var bolnikData1=[];
    var bolnikData2=[];
    var empty=true;
    console.log("inside iframe");
    
    
    function getT(ehrId){
        console.log("inside getT");
        sessionId = getSessionId();
        
        $.ajax({
		url: baseUrl + "/demographics/ehr/" + ehrId + "/party",
    	type: 'GET',
    	headers: {"Ehr-Session": sessionId},
    	success: function (data) {
			var party = data.party;
			$.ajax({
			    url: baseUrl + "/view/" + ehrId + "/" + "weight",
			    type: 'GET',
			    headers: {"Ehr-Session": sessionId},
			    success: function (res) {
			    	if (res.length > 0) {
			    		// res je 0
				        for (var i=0;i<res.length;i++) {
				        			console.log("5");
				        	bolnikData1[i]=res[res.length-1-i].weight;
				        	bolnikData2[i]=res[res.length-1-i].time;

				           
				            
				            		console.log(" \n iframe: "+res[i].time+"   "+res[i].weight + "   " 	+ res[i].unit);
				            		
				            		
				            		//narisat graf v #grafi
				            	//	d3.select("body").append("p").text("d3 izpis: "+res[i].time+"   "+res[i].weight + "   " 	+ res[i].unit);
				            		
				        }
				        if(  (bolnikData1.length>0) && (bolnikData2.length>0) &&(empty)){
				            //nariši graf s temi podatki prvic
				            
				            
				            
				            
                            // Set the dimensions of the canvas / graph
                            var margin = {top: 0, right: 0, bottom: 0, left: 0},
                                width = 1200 - margin.left - margin.right,
                                height = 600 - margin.top - margin.bottom;
                            
                            // Parse the date / time brez sekund verjetno
                            
                            //      2005-11-20T13:00:00.000+01:00
                            
                            
                            var parseDate = d3.time.format("%Y-%m-%dT%H:%MZ").parse;
                            
                            // Set the ranges
                            var x = d3.time.scale().range([0, width]);
                            var y = d3.scale.linear().range([height, 0]);
                            
                            // Define the axes
                            var xAxis = d3.svg.axis().scale(x)
                                .orient("bottom").ticks(5);
                            
                            var yAxis = d3.svg.axis().scale(y)
                                .orient("left").ticks(5);
                            
                            // Define the line
                            var valueline = d3.svg.line()
                                .x(function(d) { return x(d.date); })
                                .y(function(d) { return y(d.teza); });
                                
                            // Adds the svg canvas
                            var svg = d3.select("body")
                                .append("svg")
                                    .attr("width", width + margin.left + margin.right)
                                    .attr("height", height + margin.top + margin.bottom)
                                .append("g")
                                    .attr("transform", 
                                          "translate(" + margin.left + "," + margin.top + ")");
                            
                            // Get the data
                            var data=[];
                            for(var i=0;i<bolnikData1.length;i++){
                                var da= parseDate(bolnikData2[i]);
                                console.log("parsanje datuma: "+bolnikData2+"  "+da+"\n");
                                var obj={date: parseDate(bolnikData2[i]), teza: bolnikData1[1] }
                                data.push(obj);
                            }
                            
                                // Scale the range of the data
                                x.domain(d3.extent(data, function(d) { return d.date; }));
                                y.domain([0, d3.max(data, function(d) { return d.teza; })]);
                            
                                // Add the valueline path.
                                svg.append("path")
                                    .attr("class", "line")
                                    .attr("d", valueline(data));
                            
                                // Add the X Axis
                                svg.append("g")
                                    .attr("class", "x axis")
                                    .attr("transform", "translate(0," + height + ")")
                                    .call(xAxis);
                            
                                // Add the Y Axis
                                svg.append("g")
                                    .attr("class", "y axis")
                                    .call(yAxis);
                            

				        }else if((bolnikData1.length>0) && (bolnikData2.length>0) &&(!empty)){
				            //posodobitev že obstojecega grafa
				            
				        }
				     
			    	} else {

			    	}
			    },
			    error: function() {
					console.log(JSON.parse(err.responseText).userMessage);
			    }
			});					
			
    	},
    	error: function(err) {
			console.log(JSON.parse(err.responseText).userMessage);
    	}
	});
        
    }
    
    function getSessionId() {
    var response = $.ajax({
        type: "POST",
        url: baseUrl + "/session?username=" + encodeURIComponent(username) +
                "&password=" + encodeURIComponent(password),
        async: false
    });
    return response.responseJSON.sessionId;
}
    
    
    
    
    
    function init(){
        var canvas=d3.select("body")
					.append("svg")
					.attr("width", 500)
			    	.attr("height",500);
												
		var circle = canvas.append("circle")
						.attr("cx",100)
						.attr("cy", 100)
						.attr("r", 50)
						.attr("fill", "red");
    }
    
    
    /*
        d3.select("body").append("p").text("yoo")
       // var data=main.js.bolnikData1;
        											var canvas=d3.select("body")
												.append("svg")
												.attr("width", 500)
												.attr("height",500);
												
											var circle = canvas.append("circle")
															.attr("cx",100)
															.attr("cy", 100)
															.attr("r", 50)
															.attr("fill", "red");
															
															*/
															
    </script>
    </body>
</html>